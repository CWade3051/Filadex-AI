version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-filadex}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-filadex}
      - POSTGRES_DB=${POSTGRES_DB:-filadex}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-filadex}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Filadex Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080
      - PGHOST=db
      - PGPORT=5432
      - PGUSER=${POSTGRES_USER:-filadex}
      - PGPASSWORD=${POSTGRES_PASSWORD:-filadex}
      - PGDATABASE=${POSTGRES_DB:-filadex}
      - DATABASE_URL=postgres://${POSTGRES_USER:-filadex}:${POSTGRES_PASSWORD:-filadex}@db:5432/${POSTGRES_DB:-filadex}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD:-admin}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE:-en}
      - INIT_SAMPLE_DATA=${INIT_SAMPLE_DATA:-true}
      # AI Features - OpenAI API key (optional, can also be set per-user in settings)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # HOST_IP is REQUIRED for mobile QR code uploads to work
      # Set this to your host machine's IP address (e.g., 192.168.1.100)
      - HOST_IP=${HOST_IP:-}
      # JWT Secret for session tokens (auto-generated by reset-docker.sh)
      - JWT_SECRET=${JWT_SECRET:-}
    depends_on:
      - db
    ports:
      - "${APP_PORT:-8080}:8080"
    volumes:
      # Persist uploaded filament images
      - filament_uploads:/app/public/uploads

volumes:
  postgres_data:
  filament_uploads:

# Note: This is a template file. Copy to docker-compose.yml and modify as needed.
# For production deployments, consider adding:
# 1. A reverse proxy like Traefik or Nginx for SSL termination
# 2. Proper network configuration for security
# 3. Backup solutions for the database volume
# 4. Environment-specific configurations
